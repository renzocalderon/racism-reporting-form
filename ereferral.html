<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>E-Referral â€“ KF&LA Anti-Racism Reporting</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--accent:#0046ad;--radius:.5rem;}
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
    body{
      font-family:Arial,sans-serif;background:#f5f8fa;line-height:1.55;
      display:flex;flex-direction:column;align-items:center;padding:0 1rem;
    }
    .container{
      background:#fff;margin:40px auto;padding:30px 40px;border-radius:10px;
      max-width:600px;width:100%;box-shadow:0 4px 10px rgba(0,0,0,.1);
    }
    h1{text-align:center;color:var(--accent);margin-bottom:30px;font-size:1.75rem;}
    label{display:block;font-weight:bold;margin:20px 0 8px;}
    input[type="text"],input[type="email"],input[type="tel"]{
      width:100%;padding:10px;border:1px solid #ccc;border-radius:var(--radius);
    }
    .options{margin-left:20px;}
    button{
      display:block;margin:30px auto 0;padding:12px 28px;font-size:16px;
      color:#fff;background:var(--accent);border:none;border-radius:8px;
      cursor:pointer;transition:background .2s;
    }
    button:hover{background:#003a8f;}
  </style>

  <!-- EmailJS SDK -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    //  Initialize EmailJS with your public key
    window.addEventListener('DOMContentLoaded', () => {
      emailjs.init('EfdmEbsJzre7RXquc');
    });
  </script>
</head>
<body>
  <div class="container">
    <h1>Contact Information for e-Referral</h1>

    <form id="ereferralForm">
      <!-- Preferred contact -->
      <label>Preferred contact method:</label>
      <div class="options">
        <input type="radio" name="contact_method" value="Email" required /> Email<br />
        <input type="radio" name="contact_method" value="Phone" /> Phone<br />
        <input type="radio" name="contact_method" value="Either" /> Either is fine
      </div>

      <!-- Email -->
      <label>Email address:</label>
      <input type="email" name="email" placeholder="you@example.com" />

      <!-- Phone -->
      <label>Phone number:</label>
      <input type="tel" name="phone" placeholder="555-123-4567" />

      <button type="submit">Submit e-Referral</button>
    </form>
  </div>

  <script>
    /** Build a plain-text summary for the e-mail body */
    function buildSummary(report, contact){
      const out=[];
      out.push('=== Contact ===');
      out.push(`Preferred : ${contact.contact_method||'N/A'}`);
      out.push(`Email     : ${contact.email||'N/A'}`);
      out.push(`Phone     : ${contact.phone||'N/A'}`);
      out.push('');
      out.push('=== Incident ===');
      if(report.incident_date||report.incident_time){
        out.push(`Date/Time : ${(report.incident_date||'').trim()} ${(report.incident_time||'').trim()}`.trim());
      }
      if(report.incident_location){
        const loc=Array.isArray(report.incident_location)?report.incident_location.join(', '):report.incident_location;
        out.push(`Location  : ${loc}`);
      }
      if(report.incident_address) out.push(`Address   : ${report.incident_address}`);
      out.push('');
      out.push('Details:');
      out.push(report.incident_details||'(none provided)');
      out.push('');
      out.push('-- End of summary --');
      return out.join('\n');
    }

    document.getElementById('ereferralForm').addEventListener('submit', async (e)=>{
      e.preventDefault();

      /* 1. Collect contact details */
      const fd=new FormData(e.target);
      const contact={};
      fd.forEach((v,k)=>contact[k]=v);

      /* 2. Retrieve stored report (set in report.html) */
      let report={};
      try{ report=JSON.parse(sessionStorage.getItem('reportJSON')||'{}'); }catch{}

      /* 3. Build template params expected by EmailJS */
      const tpl={
        name   : report.respondent_name || 'Anonymous',          // {{name}}
        time   : new Date().toLocaleString(),                    // {{time}}
        message: buildSummary(report,contact),                   // {{message}}
        email  : contact.email || ''                             // {{email}} (for Reply-To if used)
      };

      /* 4. Send via EmailJS */
      try{
        await emailjs.send('service_6cqtuid','template_y4a4c2q',tpl);
      }catch(err){
        alert('Email send failed: ' + (err.text || err));
        return;
      }

      /* 5. Success popup */
      const w=window.open();
      w.document.write(`
        <html><head><title>Thank You</title>
        <style>
          body{font-family:Arial,sans-serif;background:#f0f4f8;text-align:center;
               padding:100px;color:#2b4c6f;}
        </style></head><body>
          <h1>Thank you. Your e-referral has been sent.</h1>
          <p>A community partner will contact you using your preferred method.</p>
        </body></html>`);
      w.document.close();
    });
  </script>
</body>
</html>
