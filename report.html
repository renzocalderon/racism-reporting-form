<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Racism Reporting Form</title>
  <style>
    body{
      font-family:Arial,sans-serif;background:#f5f8fa;margin:0;padding:0;
      display:flex;flex-direction:column;align-items:center;
    }
    .container{
      background:#fff;margin:40px auto;padding:30px 40px;border-radius:10px;
      max-width:800px;box-shadow:0 4px 10px rgba(0,0,0,0.1);position:relative;
    }
    .logo{position:absolute;top:30px;right:30px;width:120px;}
    h1{text-align:center;color:#2b4c6f;margin-bottom:40px;}
    label{display:block;font-weight:bold;margin:20px 0 10px;}
    input[type="text"],input[type="date"],input[type="time"],textarea{
      width:100%;padding:8px;margin-top:5px;border:1px solid #ccc;border-radius:5px;
    }
    textarea{resize:vertical;height:80px;}
    .options{margin-left:20px;}
    /* --- buttons --- */
    .btn{
      display:block;margin:30px auto 0;padding:12px 24px;font-size:16px;
      color:#fff;background:#2b4c6f;border:none;border-radius:8px;cursor:pointer;
      transition:background .2s;
    }
    .btn:hover{background:#3e618c;}
    /* keep a small gap between the two buttons */
    .btn + .btn{margin-top:15px;}
  </style>
</head>
<body>
  <div class="container">
    <img class="logo"
         src="https://uwaytbay.ca/wp-content/uploads/2023/02/211-Ontario-Logo-01.png"
         alt="Ontario 211 Logo">
    <h1>Racism Reporting Form</h1>

    <!-- ========== FORM ========== -->
    <form id="reportForm">
      <!-- … all existing questions unchanged … -->

      <!-- Follow-up contact (conditional) -->
      <div id="followUpContact" style="display:none;margin-top:10px;">
        <label>Phone number (optional):</label>
        <input type="text" name="follow_up_phone">
        <label>Email (optional):</label>
        <input type="text" name="follow_up_email">
      </div>

      <!-- Postal code (conditional) -->
      <div id="postalCodeField" style="display:none;margin-top:10px;">
        <label>Postal Code (to tailor community resources):</label>
        <input type="text" name="postal_code">
      </div>

      <!-- ========== ACTION BUTTONS ========== -->
      <button type="submit" id="submitBtn" class="btn">Submit Form</button>
      <button type="button" id="ereferralBtn" class="btn">Submit e-Referral</button>
    </form>
  </div>

  <script>
    /* ---------- existing JS (unchanged) ---------- */
    const form = document.getElementById("reportForm");

    form.onsubmit = async (e) => {
      e.preventDefault();
      const formData = new FormData(form);
      const data = {};

      formData.forEach((value, key) => {
        if (data[key]) {
          if (Array.isArray(data[key])) {
            data[key].push(value);
          } else {
            data[key] = [data[key], value];
          }
        } else {
          const field = form.querySelectorAll(`[name="${key}"]`);
          if (field.length > 1 && field[0].type === "checkbox") {
            data[key] = [value];
          } else {
            data[key] = value;
          }
        }
      });

      try {
        const response = await fetch(
          "https://survey211.azurewebsites.net/api/savesurvey",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          }
        );

        if (response.ok) {
          const wantsFollowUp = data["follow_up"] === "yes";
          const message = wantsFollowUp
            ? "Thank you for your participation. A 211 representative will follow up with you shortly."
            : "Thank you for your participation. You can find more information at https://211ontario.ca/";

          const newWindow = window.open();
          newWindow.document.write(`
            <html>
              <head>
                <title>Thank You</title>
                <style>
                  body{font-family:Arial,sans-serif;background:#f0f4f8;text-align:center;
                       padding:100px;color:#2b4c6f;}
                  a{color:#2b4c6f;text-decoration:underline;}
                </style>
              </head>
              <body>
                <h1>${message}</h1>
                ${
                  !wantsFollowUp
                    ? `<p><a href="https://211ontario.ca/" target="_blank">Visit 211 Ontario</a></p>`
                    : ""
                }
              </body>
            </html>
          `);
          newWindow.document.close();
        } else {
          alert("Submission failed: " + (await response.text()));
        }
      } catch (err) {
        alert("Error: " + err.message);
      }
    };

    /* show/hide follow-up contact fields */
    document.querySelectorAll('input[name="follow_up"]').forEach((input) => {
      input.addEventListener("change", () => {
        document.getElementById("followUpContact").style.display =
          input.value === "yes" ? "block" : "none";
      });
    });

    /* show/hide postal-code field for resource summary */
    document.querySelectorAll('input[name="resource_summary"]').forEach((input) => {
      input.addEventListener("change", () => {
        document.getElementById("postalCodeField").style.display =
          input.value === "yes" ? "block" : "none";
      });
    });

    /* ---------- NEW: e-Referral button ---------- */
    document.getElementById("ereferralBtn").addEventListener("click", () => {
      // Later you can collect form data & pass via sessionStorage if needed
      window.location.href = "ereferral.html";  // placeholder page
    });
  </script>
</body>
</html>
